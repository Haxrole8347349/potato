--Clati e slab? (Enhanced with Vicious Bee Auto-Fix)

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local lp = Players.LocalPlayer

-- =========================
-- WHITELIST (NU STERGE ACESTEA!)
-- =========================
local function isSafeObject(obj)
    -- NU atinge GUI-ul playerului
    local parent = obj
    while parent do
        if parent == lp.PlayerGui or parent == game.CoreGui then
            return true
        end
        if parent.Name == "ViciousBeeHunterGUI" then
            return true
        end
        parent = parent.Parent
    end
    
    -- NU atinge caracterul playerului
    if lp.Character and (obj == lp.Character or obj:IsDescendantOf(lp.Character)) then
        return true
    end
    
    -- NU atinge camera
    if obj:IsA("Camera") then
        return true
    end
    
    -- ‚ö†Ô∏è CRITICAL: NU STERGE "Particles" folder (aici sunt Thorn-urile!)
    if obj.Name == "Particles" or obj:IsDescendantOf(Workspace:FindFirstChild("Particles") or game) then
        return true
    end
    
    -- NU sterge terenul
    if obj == Workspace.Terrain then
        return true
    end
    
    -- NU sterge spawn locations (necesare pentru respawn)
    if obj:IsA("SpawnLocation") or obj:FindFirstChildOfClass("SpawnLocation") then
        return true
    end
    
    -- NU sterge NPCs importante (shop-uri,quest givers)
    if obj:FindFirstChild("Humanoid") and obj:FindFirstChild("ClickDetector") then
        return true
    end
    
    return false
end

-- =========================
-- RAM CLEANUP (SAFE MODE)
-- =========================
print("üßπ Starting SAFE RAM cleanup...")

local cleaned = 0

for _, obj in ipairs(Workspace:GetDescendants()) do
    if isSafeObject(obj) then continue end
    
    -- Sterge DOAR efecte vizuale consumatoare de RAM
    if obj:IsA("ParticleEmitter") 
    or obj:IsA("Trail") 
    or obj:IsA("Beam")
    or obj:IsA("Smoke")
    or obj:IsA("Fire")
    or obj:IsA("Sparkles") then
        -- ‚ö†Ô∏è EXCEP»öIE: NU sterge dacƒÉ e √Æn folder "Particles" (Thorn effects)
        if not obj:IsDescendantOf(Workspace:FindFirstChild("Particles") or game) then
            obj:Destroy()
            cleaned = cleaned + 1
        end
    end
    
    -- Sterge lumini (economie mare de RAM)
    if obj:IsA("PointLight") or obj:IsA("SpotLight") or obj:IsA("SurfaceLight") then
        obj:Destroy()
        cleaned = cleaned + 1
    end
    
    -- Sterge sunete la distan»õƒÉ (pƒÉstreazƒÉ cele active)
    if obj:IsA("Sound") and not obj.Playing then
        local dist = math.huge
        if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = lp.Character.HumanoidRootPart
            if obj:IsA("BasePart") then
                dist = (obj.Position - hrp.Position).Magnitude
            elseif obj.Parent and obj.Parent:IsA("BasePart") then
                dist = (obj.Parent.Position - hrp.Position).Magnitude
            end
        end
        
        if dist > 200 then
            obj:Destroy()
            cleaned = cleaned + 1
        end
    end
    
    -- Sterge texturi (DAR NU din GUI sau Particles!)
    if (obj:IsA("Decal") or obj:IsA("Texture") or obj:IsA("SurfaceAppearance")) then
        obj:Destroy()
        cleaned = cleaned + 1
    end
end

print("‚úÖ Cleaned " .. cleaned .. " objects (Particles folder PRESERVED)")

-- =========================
-- LIGHTING CLEANUP
-- =========================
Lighting.GlobalShadows = false
Lighting.Brightness = 1
Lighting.FogEnd = 9e9
Lighting.EnvironmentDiffuseScale = 0
Lighting.EnvironmentSpecularScale = 0

for _, fx in ipairs(Lighting:GetChildren()) do
    if fx:IsA("PostEffect") or fx:IsA("Atmosphere") or fx:IsA("Sky") then
        fx:Destroy()
    end
end

-- =========================
-- RENDER SETTINGS (FPS + RAM)
-- =========================
pcall(function()
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
end)

pcall(function()
    settings().Physics.PhysicsEnvironmentalThrottle = Enum.EnviromentalPhysicsThrottle.Skip
    settings().Physics.AllowSleep = true
end)

-- =========================
-- PERIODIC DISTANCE CLEANUP (SAFE)
-- =========================
task.spawn(function()
    while true do
        task.wait(10) -- La fiecare 10 secunde
        
        if not lp.Character or not lp.Character:FindFirstChild("HumanoidRootPart") then 
            task.wait(5)
            continue 
        end
        
        local hrp = lp.Character.HumanoidRootPart
        local distCleaned = 0
        
        for _, part in ipairs(Workspace:GetDescendants()) do
            if isSafeObject(part) then continue end
            if not part:IsA("BasePart") then continue end
            
            -- Sterge doar obiecte FOARTE DEPARTE (300+ studs)
            local dist = (part.Position - hrp.Position).Magnitude
            
            if dist > 300 then
                -- NU sterge dacƒÉ are ClickDetector (pot fi quest items)
                if not part:FindFirstChildOfClass("ClickDetector") then
                    part:Destroy()
                    distCleaned = distCleaned + 1
                end
            end
        end
        
        if distCleaned > 0 then
            print("üóëÔ∏è Removed " .. distCleaned .. " distant objects")
        end
        
        -- Garbage collection agresiv
        collectgarbage("collect")
        collectgarbage("collect")
    end
end)

-- =========================
-- üÜï VICIOUS BEE AUTO-FIXER (MEMORY LEAK REPAIR)
-- =========================
print("üêù Starting Vicious Bee memory leak auto-fixer...")

task.spawn(function()
    while true do
        task.wait(120) -- La fiecare 2 minute
        
        -- VerificƒÉ dacƒÉ scriptul Vicious Bee ruleazƒÉ
        if not _G.ViciousBeeConfig then 
            task.wait(30)
            continue 
        end
        
        local config = _G.ViciousBeeConfig
        local cleaned = 0
        
        -- üîß FIX 1: CurƒÉ»õƒÉ property connections moarte
        if config._propertyConnections then
            local alive = {}
            for _, conn in pairs(config._propertyConnections) do
                if conn and conn.Connected then
                    table.insert(alive, conn)
                else
                    pcall(function() conn:Disconnect() end)
                    cleaned = cleaned + 1
                end
            end
            config._propertyConnections = alive
            
            -- üîß LIMIT: Max 100 connections (previne acumulare)
            if #alive > 100 then
                print("‚ö†Ô∏è Vicious Bee: TOO MANY CONNECTIONS (" .. #alive .. "), clearing oldest 50")
                for i = 1, 50 do
                    pcall(function() alive[i]:Disconnect() end)
                    cleaned = cleaned + 1
                end
                config._propertyConnections = {table.unpack(alive, 51)}
            end
        end
        
        -- üîß FIX 2: CurƒÉ»õƒÉ _detectedStingers table
        if config._detectedStingers then
            local oldCount = 0
            for obj, status in pairs(config._detectedStingers) do
                oldCount = oldCount + 1
                if typeof(obj) ~= "Instance" or not obj.Parent or status == "defeated" then
                    config._detectedStingers[obj] = nil
                    cleaned = cleaned + 1
                end
            end
            
            -- üîß LIMIT: Max 50 entries
            if oldCount > 50 then
                print("‚ö†Ô∏è Vicious Bee: Too many detected stingers (" .. oldCount .. "), clearing old ones")
                config._detectedStingers = {}
                cleaned = cleaned + oldCount
            end
        end
        
        -- üîß FIX 3: CurƒÉ»õƒÉ webhook cache AGRESIV
        local now = tick()
        
        if config._lastWebhooks then
            for k, t in pairs(config._lastWebhooks) do
                if now - t > 3 then -- 3 sec √Æn loc de 5
                    config._lastWebhooks[k] = nil
                    cleaned = cleaned + 1
                end
            end
        end
        
        if config._lastLogSend then
            for k, t in pairs(config._lastLogSend) do
                if now - t > 10 then -- 10 sec √Æn loc de 30
                    config._lastLogSend[k] = nil
                    cleaned = cleaned + 1
                end
            end
        end
        
        -- üîß FIX 4: Disconnect duplicate monitoring connections
        if config._playerMonitorConnection and config._playerRemovingConnection then
            -- VerificƒÉ dacƒÉ sunt duplicate (mai multe instan»õe)
            local monitorCount = 0
            local removingCount = 0
            
            -- Nu putem numƒÉra direct, dar putem verifica dacƒÉ existƒÉ leak
            -- prin verificarea dacƒÉ monitoring este activ dar stinger nu e detectat
            if not config.stingerDetected and config._monitoringActive then
                print("‚ö†Ô∏è Vicious Bee: Monitoring leak detected, fixing...")
                
                pcall(function() 
                    if config._playerMonitorConnection then
                        config._playerMonitorConnection:Disconnect()
                    end
                end)
                pcall(function() 
                    if config._playerRemovingConnection then
                        config._playerRemovingConnection:Disconnect()
                    end
                end)
                
                config._playerMonitorConnection = nil
                config._playerRemovingConnection = nil
                config._monitoringActive = false
                cleaned = cleaned + 2
            end
        end
        
        -- üîß FIX 5: Force GC pentru Vicious Bee
        collectgarbage("collect")
        collectgarbage("collect")
        
        if cleaned > 0 then
            print("üêù Vicious Bee Auto-Fix: Cleaned " .. cleaned .. " leaked objects")
        end
    end
end)

-- =========================
-- üÜï ENHANCED RAM MONITOR (with Vicious Bee stats)
-- =========================
task.spawn(function()
    while true do
        task.wait(60) -- La fiecare minut
        
        local memUsage = collectgarbage("count") / 1024 -- MB
        
        -- Stats pentru Vicious Bee (dacƒÉ ruleazƒÉ)
        local vicStats = ""
        if _G.ViciousBeeConfig then
            local config = _G.ViciousBeeConfig
            local connCount = config._propertyConnections and #config._propertyConnections or 0
            local detectedCount = 0
            if config._detectedStingers then
                for _ in pairs(config._detectedStingers) do
                    detectedCount = detectedCount + 1
                end
            end
            vicStats = string.format(" | üêù Conn: %d | Detected: %d", connCount, detectedCount)
        end
        
        
        -- üÜï AUTO-CLEANUP dacƒÉ RAM > 150 MB
        if memUsage > 150 then
            
            -- Emergency cleanup pentru Vicious Bee
            if _G.ViciousBeeConfig then
                local config = _G.ViciousBeeConfig
                
                -- Disconnect jumƒÉtate din connections
                if config._propertyConnections and #config._propertyConnections > 20 then
                    local half = math.floor(#config._propertyConnections / 2)
                    for i = 1, half do
                        pcall(function() config._propertyConnections[i]:Disconnect() end)
                    end
                    config._propertyConnections = {table.unpack(config._propertyConnections, half + 1)}
                    print("üêù Emergency: Disconnected " .. half .. " connections")
                end
                
                -- Clear cache-uri
                config._detectedStingers = {}
                config._lastWebhooks = {}
                config._lastLogSend = {}
            end
            
            -- Force GC triplu
            collectgarbage("collect")
            collectgarbage("collect")
            collectgarbage("collect")
            
        end
    end
end)
